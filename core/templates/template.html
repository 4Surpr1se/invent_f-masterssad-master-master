{% load tags %}
<!DOCTYPE html>
<html lang="en">
<head>

    <style>
        .gender {
  display: none;
}

.btn {
  display: block;
  text-align: left;
  /*margin-top: 10px;*/
  /*border: 1px solid #ccc;*/
  cursor: pointer;
  height: 20px;
  padding: 10px 10px 9px 0px;
}

.btn:hover {
  background-color: #ccc;
  color:white;
}
        table {
  border-radius: 15px;
  box-shadow: rgba(255, 255, 255, 0.2) 0px 0px 0px 1px inset, rgba(0, 0, 0, 0.9) 0px 0px 0px 1px;
  text-align: left;
  {#width: 50%;#}
  font-family: Tahoma, sans-serif;
  background-color: white;
  border-collapse: separate;
            {#width: 222%;               #}
  {#width: 200%; <!--TODO переделать таблицу и параметры блока под нее, чтобы не юзать 200% -->#}
}
.btn_text{
    margin-top: 10px;
}
td, th {
  border: 1px solid #dddddd;
  text-align: left;
  height: 40px;
    width: max-content;

<!--  padding: 2px;-->
}
p {
    text-align: right;
}

#createform{

    position: sticky;
    padding: 4% 3%;
    float: right;
    text-align: center;
    display: block;
}

#container {
    overflow:hidden;
    position:relative;

    margin:0;
    padding:0;
}

#visibility_changer{
    visibility: visible;
}

#backgroundsuccess {
    background-color: lightgreen;
    float: right;
    text-align: center;
    display: block;
    border: 2px solid grey;
    animation: cssAnimation 5s forwards;
    -moz-animation: cssAnimation 0s ease-in 5s forwards;
    -webkit-animation: cssAnimation 0s ease-in 5s forwards;
    padding: 0.5%;
}

@keyframes cssAnimation {
    0%   {opacity: 1;}
    90%  {opacity: 1;}
    100% {opacity: 0;}
}

@-webkit-keyframes cssAnimation {
    0%   {opacity: 1;}
    90%  {opacity: 1;}
    100% {opacity: 0;}
}

#searchtable{
    float: left;
    position: relative;
    width: 15%;
    block-size: auto;
}

#searchfield{
    float: left;
    /*width: 17%;*/
<!--    padding: 0.25%;-->
    /*block-size: auto;*/
}

#searchbutton{
    /*display: block;*/
    /*padding: 0.25%;*/
    width: 3px;
    height: 1%;
}

#block1 {
    float: left;
    display: block;
    width: 27%;
}


        a:link {
            text-decoration: none;
        }

        a:visited {
            text-decoration: none;
        }

        a:hover {
            text-decoration: blink;
            /*background: #cdfeaa;*/
        }
        a:focus{
            /*background: orangered;*/
        }

        a:active {
            text-decoration: blink;
        }




tr:nth-child(even) {
  background-color: #dddddd;
}
/**/
/*        */
/*              */
nav ul ul {
        display: none;
      }
      nav ul li:hover > ul {
        display: block;
      }
      nav ul:after {
        content: "";
        clear: both;
        display: block;

      }
      nav ul li {
        float: left;
        position: relative;
        list-style-type: none;
      }
      nav ul li:hover {
        background: rgba(19, 20, 123, 0.67);
      }
      nav ul li:hover a {
        color: #fff;


      }
      nav ul li a {
        display: block;
        padding: 20px 30px;
        color: #ffffff;
        text-decoration: none;
        background-color: rgba(35, 17, 134, 0.8);
        font-family: sans-serif;
        text-align: left;
      }
      nav ul ul {
        background: #5f6975;
        padding: 0;
        position: absolute;
        top: 100%;
      }
      nav ul ul li {
        float: none;
        position: relative;

      }
      nav ul ul li a {
        padding: 15px 10px;
        color: #ffffff;

          position: relative;
        text-transform: uppercase;
      }
      nav ul ul li a:hover {
        background: rgba(19, 20, 123, 0.67);
      }

    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        padding-top: 100px; /* Location of the box */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }

    /* Modal Content */
    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 15%;
        height: 45%; {# TODO чтобы высчиывался в зависимости от количества строк и таблицу так же, чтобы от количества столобцов и строк #}
        text-align: center;
        align-content: center;
    }

    /* The Close Button */
    .close {
        color: #aaaaaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
    }
    .labelcls {
        font-family: 'Lucida Console';
}

    .inputcls {
        width: 90%;
        height: 23px
}
    .button-6 {
        align-items: center;
        background-color: #FFFFFF;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: .25rem;
        box-shadow: rgba(0, 0, 0, 0.02) 0 1px 3px 0;
        box-sizing: border-box;
        color: rgba(0, 0, 0, 0.85);
        cursor: pointer;
        display: inline-flex;
        font-family: system-ui,-apple-system,system-ui,"Helvetica Neue",Helvetica,Arial,sans-serif;
        font-size: 16px;
        font-weight: 600;
        justify-content: center;
        line-height: 1.25;
        margin: 0;
        min-height: 3rem;
        padding: calc(.875rem - 1px) calc(1.5rem - 1px);
        position: relative;
        text-decoration: none;
        transition: all 250ms;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
        vertical-align: baseline;
        width: auto;
        }

    .button-6:hover,
    .button-6:focus {
        border-color: rgba(0, 0, 0, 0.15);
        box-shadow: rgba(0, 0, 0, 0.1) 0 4px 12px;
        color: rgba(0, 0, 0, 0.65);
}

    .button-6:hover {
        transform: translateY(-1px);
}

        .button-6:active {
        background-color: #F0F0F1;
        border-color: rgba(0, 0, 0, 0.15);
        box-shadow: rgba(0, 0, 0, 0.06) 0 2px 4px;
        color: rgba(0, 0, 0, 0.65);
        transform: translateY(0);
}

    form:not(#empty) {
  --c: #FF908B;
  {#--c: rgba(0, 0, 0, 1);    /* the border color */#}
  --b: 10px;    /* the border thickness*/
  --g: 5px;     /* the gap on hover */

  padding: calc(var(--g) + var(--b));
  --_g: #0000 25%,var(--c) 0;
  background:
    conic-gradient(from 180deg at top    var(--b) right var(--b),var(--_g))
     var(--_i,200%) 0  /200% var(--_i,var(--b))  no-repeat,
    conic-gradient(            at bottom var(--b) left  var(--b),var(--_g))
     0   var(--_i,200%)/var(--_i,var(--b)) 200%  no-repeat;
  transition: .3s, background-position .3s .3s;
  cursor: pointer;
}
form:hover:not(#empty) {
  --_i: 100%;
  transition: .3s, background-size .3s .3s;
}

        body {
  z-index: 2;
  --s: 150px; /* control the size */

  background:
    linear-gradient(135deg,#0000 18.75%,#CCCCCC 0 31.25%,#0000 0),
    repeating-linear-gradient(45deg,#CCCCCC -6.25% 6.25%,white 0 18.75%);
  background-size: var(--s) var(--s);
}
        .smcls{
          z-index: 2;
  --s: 150px; /* control the size */

  background:
    linear-gradient(135deg,#0000 18.75%,#CCCCCC 0 31.25%,#0000 0),
    repeating-linear-gradient(45deg,#CCCCCC -6.25% 6.25%,white 0 18.75%);
  background-size: var(--s) var(--s);
        }

.alert {
  position: fixed;
  padding: 20px;
  background-color: #f44336;
  color: white;
  right: 10px;
  display: none;
}

.closebtn {
    margin-left: 15px;
    color: white;
    font-weight: bold;
    float: right;
    font-size: 22px;
    line-height: 20px;
    cursor: pointer;
}

.closebtn:hover {
  color: black;
}




    </style>

{% if query.0.keys is None %}
    {% get_query_keys serializer as query %}

{% endif %}
    <body>
        <meta charset="UTF-8">
        <title>title</title>
    <div class="alert" id="alert_button">
  <span class="closebtn" id="alert_span" onclick="this.parentElement.style.display='none';">&times;</span>
  <strong>Danger!</strong> Indicates a dangerous or potentially negative action.
</div>
    <div style="position: relative;
          right: 40px;">
    <nav>
      <ul>
        <li>
          <a href="../lk/">Личный Кабинет</a>
        </li>
        <li>
            {% if retrieve %}
          <a href="../../hol/">Холдинги</a>
            {% else %}
          <a href="../hol/">Холдинги</a>
            {% endif %}
{#          <ul>#}
{#            <li>#}
{#              <a href="https://www.w3docs.com/quiz-start/html-basic">HTML Bacis</a>#}
{#            </li>#}
{#            <li>#}
{#              <a href="https://www.w3docs.com/quiz-start/css-basic">CSS Bacis</a>#}
{#            </li>#}
{#            <li>#}
{#              <a href="https://www.w3docs.com/quiz-start/javascript-basic">JavaScript Bacis</a>#}
{#            </li>#}
{#            <li>#}
{#              <a href="https://www.w3docs.com/quiz-start/php-basic">PHP Bacis</a>#}
{#            </li>#}
{#            <li>#}
{#              <a href="https://www.w3docs.com/quiz-start/es6-basic">ES6 Bacis</a>#}
{#            </li>#}
{#          </ul>#}
        </li>
        <li>
            {% if retrieve %}
          <a href="../../org/">Организации</a>
            {% else %}
          <a href="../org/">Организации</a>
            {% endif %}
{#          <ul>#}
{#            <li>#}
{#              <a href="https://www.w3docs.com/snippets/angularjs.html">Angular JS</a>#}
{#            </li>#}
{#            <li>#}
{#              <a href="https://www.w3docs.com/snippets/apache.html">Apache</a>#}
{#            </li>#}
{#            <li>#}
{#              <a href="https://www.w3docs.com/snippets/git.html">Git</a>#}
{#            </li>#}
{#            <li>#}
{#              <a href="https://www.w3docs.com/snippets/linux.html">Linux</a>#}
{#            </li>#}
{#            <li>#}
{#              <a href="https://www.w3docs.com/snippets/nodejs.html">Node.Js</a>#}
{#            </li>#}
{#            <li>#}
{#              <a href="https://www.w3docs.com/snippets/symfony.html">Symfony</a>#}
{#            </li>#}
{#          </ul>#}
        </li>
        <li>
            {% if retrieve %}
          <a href="../../dep/">Отделы</a>
            {% else %}
          <a href="../dep/">Отделы</a>
            {% endif %}
{#          <ul>#}
{#            <li>#}
{#              <a href="https://www.w3docs.com/tools/html-encoder/">HTML ENCODER/DECODER</a>#}
{#            </li>#}
{#            <li>#}
{#              <a href="https://www.w3docs.com/css3-maker/border-radius">CSS MAKER</a>#}
{#            </li>#}
{#            <li>#}
{#              <a href="https://www.w3docs.com/tools/password-generator">PASSWORD GENERATOR</a>#}
{#            </li>#}
{#            <li>#}
{#              <a href="https://www.w3docs.com/tools/image-base64">Base 64</a>#}
{#            </li>#}
{#            <li>#}
{#              <a href="https://www.w3docs.com/tools/code-diff/">CODE DIFF</a>#}
{#            </li>#}
{#          </ul>#}
        </li>
        <li>
            {% if retrieve %}
          <a href="../../mol">МОЛЫ</a>
            {% else %}
          <a href="../mol">МОЛЫ</a>
            {% endif %}
{#          <ul>#}
{#            <li>#}
{#              <a href="https://www.w3docs.com/tools/string-revers">STRING REVERSE</a>#}
{#            </li>#}
{#            <li>#}
{#              <a href="https://www.w3docs.com/tools/string-word-count">STRING WORD COUNT</a>#}
{#            </li>#}
{#            <li>#}
{#              <a href="https://www.w3docs.com/tools/string-remove-empty-lines">EMPTY LINES REMOVER</a>#}
{#            </li>#}
{#          </ul>#}
        </li>
        <li>
            {% if retrieve %}
          <a href="../../inv">Инвентарный Список</a>
            {% else %}
          <a href="../inv">Инвентарный Список</a>
            {% endif %}
          <ul>
            <li>
            {% if retrieve %}
          <a href="../../prop">Имущества</a>
            {% else %}
          <a href="../prop">Имущества</a>
            {% endif %}
            </li>
            <li>
            {% if retrieve %}
              <a href="../../oper">Операции</a>
            {% else %}
              <a href="../oper">Операции</a>
            {% endif %}
            </li>
{#            <li>#}
{#              <a href="https://www.w3docs.com/tools/string-remove-empty-lines">EMPTY LINES REMOVER</a>#}
{#            </li>#}
          </ul>
        </li>

      </ul>
    </nav>
    </div>
    <form action="" id ="empty">
   <p style="height: 30px"><input type="search" name="search" id="searchfield" placeholder="Поиск по названию">
   <input type="submit" style="float: left" value="Найти">
        </form>
    <button class = button-6 style="
    width: 150px;
    height: 40px;" onclick="show()">Режим редактирования</button></p>
<div id="myModal" class="modal">

  <div class="modal-content">
    <span class="close" id="close_property">&times;</span>

  <br>
      {% for k, v in upper_query.0.items %}
      {% if k != 'id' %}
          {% if v.id != None %}
      <div>
    <label class = labelcls for="{{ k }}">{{ upper_model | verbose_name:k }}</label><br>
      <select class = inputcls name="upper_{{ k }}" id="upper_{{ k }}">
          {% for upper_foreign_key in upper_query %} {# TODO Доделать #}
              {% for key, value in upper_foreign_key.items %}
                  {% if value.id != None %}
                      <option class = labelcls value="{{value.id}}">{{value.name}}</option>
                  {% endif %}
              {% endfor %}
          {% endfor %}
      </select>
      </div>
          {% else %}
      <div>
    <label class = labelcls for="{{ k }}">{{ upper_model | verbose_name:k }}</label><br>
    <input class = inputcls name="upper_{{ k }}" id="upper_{{ k }}"/>
  </div>
              {% endif %}
      {% endif %}
      {% endfor %}
  <div>
      <br>
    <button class="button-6" onclick="PropertyAdd()" role="button" style="padding: 15px 32px;">Добавить организацию</button>
      </div>

  </div>

</div>
    {% if extra_select %}
        {% for instance in extra_select %}
    <div id="extra_myModal_{{ forloop.counter }}" class="modal">

      <div class="modal-content">
        <span class="close" id="extra_close_property_{{ forloop.counter }}">&times;</span>

      <br>
          {% dict_get extra_query_keys instance as dict_get_query %}
          {% dict_get extra_query instance as extra_queryset %}
          {% for k in dict_get_query %}
          {% if k != 'id' %}
      <div>
        <label class = labelcls for="extra_{{ forloop.parentloop.counter }}_{{ k }}">{{ extra_queryset.model | verbose_name:k }}</label><br>
        <input class = inputcls name="extra_{{ forloop.parentloop.counter }}_{{ k }}" id="extra_{{ forloop.parentloop.counter }}_{{ k }}"/>
      </div>
          {% endif %}
          {% endfor %}

      <div>
          <br>
        <button class="button-6" onclick="Extra_Add_{{ forloop.counter }}()" role="button" style="padding: 15px 32px;">Добавить организацию</button>
          </div>

      </div>

    </div>
        {% endfor %}
        {% endif %}

    <div id="block1">
        <button onclick = "SaveChanges()" style = 'display: none' class="dip button-6">Сохранить Изменения</button>
    <br>
    <br>
    <table style = "margin-left: 30px;width: 1000px">
    <script>

    </script>
            {% for obj in query.0.keys %}
            <th>{{ model | verbose_name:obj }}</th>
{#            <th style="width: 100px">Кабинет</th>#}
{#            <th style="width: 120px">Инв Номер</th>#}
{#            <th style="width: 40%">Имущество</th>#}
{#            <th style="width: 40px">Кол-во</th>#}
{#            <th style="width: 30%">Описание</th>#}
            {% endfor %}
            <th style="color: red; display:none" class="dip">Удалить</th>
            <th style="color: red; width: 30%; display:none" class="dip">Изменить</th>

        </tr>
        {% for q in query %}
            <tr>
            {% for k, v in q.items %}

                {% if k == btn_fields.lower_name %}
            <th><a style="color: black" class = "btn {{ q.id }}" href = '../{{ btn_fields.lower_url }}/?{{ model_name }}_id={{ q.id }}'><span class = "btn_text">{{ v }}</span></a></th>
                {% elif k == btn_fields.upper_name%}
            <th><a style="color: black" class = "btn {{ q.id }}" href = '../{{ btn_fields.upper_url }}/{{ v.id }}'><span class = "btn_text">{{ v.name }}</span></a></th>
                {% elif k == 'id' %}
            <th><a style="color: black"><span>{{ v }}</span></a></th>
                {% elif k == dep_field.0 %}
            <th><a style="color: black" class = "btn {{ q.id }}" href = '../{{ btn_fields.lower_url }}/{{ v.id }}'><span class = "btn_text">{{ v.name }}</span></a></th>
                 {% elif k == dep_field.1 %}
            <th><a style="color: black" class = "btn {{ q.id }}" href = '../{{ btn_fields.lower_url }}/{{ v.id }}'><span class = "btn_text">{{ v.name }}</span></a></th>
                 {% elif k == "pdf_file" %}
            <th><a style="color: black" class = "btn {{ q.id }}" href = '{{v}}'>{{ v|pdf_name }}</a></th>
                {% else %}
            <th><a style="color: black" class = "{{ q.id }}"><span>{{ v }}</span></a></th>
                {% endif %}
            {% endfor %}
            <th style = 'display:none; z-index: 1; text-align: center' class="dip"><input style="text-align: center; width: 20px; height: 20px; align-content: center; align-self: center" name="{{q.id}}" id="{{q.id}}" type="checkbox"></th>
            <th style='display:none; z-index: 1; text-align: center' class="dip"><input type="button" onclick="editable_field(this, '{{q.id}}')" value="Изменить"></th>
            </tr>
        {% endfor %}
        </table>
        </div>
        </form>

 <script>{#  TODO НЕ РАБОТАЕТ!!!#}
    var submit = []
    var steps = {{ query.0|length }} - 1 {# TODO при пустом квери упадет, поэтому нужно не прогружатть таблицу в таком случае#}
    var selection_step = {{ query.0.keys | selection_step:btn_fields.upper_name }}
 {% if extra_select %}
    {% for instance in extra_select %}
    var extra_step_{{ forloop.counter }} = {{ query.0.keys | selection_step:instance }}
    {% endfor %}
 {% endif %}
    {% if pdf_file %}
    var pdf_step = {{ query.0.keys | selection_step:'pdf_file' }}
    {% endif %}
    window.onload = function() {
    var success = sessionStorage.getItem("success");

    var error = sessionStorage.getItem("error");
    var error_response = sessionStorage.getItem("error_response")
    var show_reponse = sessionStorage.getItem("show_reponse");
    var response = sessionStorage.getItem("reponse")


    if (success === "true") {
        sessionStorage.setItem("success", "false");
        sendNotification("success", "dsa");
    }

    if (error === "true") {
        sessionStorage.setItem("error", "false");
        sendNotification('error', 'New error alert!');
    }

    if (show_reponse === "true") {
        sessionStorage.setItem("show_reponse", "false");
        sendNotification('info', response);
    }
}

function sendNotification(type, text) {
    var alert_div = document.getElementById("alert_button")
    var alert_span = document.getElementById("alert_span")

    if (type === "success") {
        alert_div.style.display = "block"
        alert_div.style.backgroundColor = "#00cc66"
    }

    else if (type === "error") {
        alert_div.style.display = "block"
    }

    alert_div.textContent = text
    alert_div.appendChild(alert_span)
}


            function show() {
         const table = document.getElementsByTagName('table')[0]
                table.style.width = '1200px'
         const a = Array.from(document.getElementsByClassName('dip'))
                a.forEach(a => {
  a.style.display = 'table-cell'})
}           var upper_discard = ''
            function editable_field(from, el) {
                from.id = el + 'changebutton'

                var confirm_button = document.createElement("input")
                confirm_button.type = 'button'
                confirm_button.value = 'Подтвердить'
                confirm_button.setAttribute('onclick', `SubmitChanges('${el}')`)

                confirm_button.className = el + 'can_con'


                var cancel_button = document.createElement("input")
                cancel_button.type = 'button'
                cancel_button.value = 'Отменить'
                cancel_button.setAttribute('onclick', `DiscardChanges('${el}')`)

                cancel_button.className = el + 'can_con'


                from.parentNode.replaceChildren(confirm_button, from)
                from.style.display = 'none'
                insertAfter(confirm_button, cancel_button)

                var svg_image = document.createElement('svg');
                svg_image.innerHTML = '<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="-5 -5 60.00 60.00" xml:space="preserve" width="25px" height="25px" fill="#000000" transform="matrix(1, 0, 0, 1, 0, 0)rotate(0)"><g id="SVGRepo_bgCarrier" stroke-width="0" transform="translate(0,0), scale(1)"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC" stroke-width="1.4000000000000001"></g><g id="SVGRepo_iconCarrier"> <circle style="fill:#43B05C;" cx="25" cy="25" r="25"></circle> <line style="fill:none;stroke:#FFFFFF;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:10;" x1="25" y1="13" x2="25" y2="38"></line> <line style="fill:none;stroke:#FFFFFF;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:10;" x1="37.5" y1="25" x2="12.5" y2="25"></line> </g></svg>'
                svg_image.style = 'align-self: center; cursor: pointer; align-content: center'
                {#var svg_image_1 = svg_image.cloneNode(true)#}

                for (let step = 0; step < steps; step++){
                var e = document.getElementsByClassName(el)[0];

                if (step === selection_step){
                        var d = document.createElement('select');
                        d.style = 'align-self: center; width: 150px; height: 20px'

                        d.className = el + 'textfield' + ' property_select'

                        {% for instance in upper_query %}

                        var option = document.createElement("option");
                        option.value = '{{instance.id}}';
                        option.text = '{{instance.name}}';
                        upper_discard = e.textContent
                        if (option.text === e.textContent){
                            option.selected = true}
                        d.appendChild(option);

                        {% endfor %}

                        e.parentNode.replaceChild(d, e);
                        svg_image.id = el + 'add_svg'
                        svg_image.setAttribute('onclick', `CreateProperty()`)
                        d.after(svg_image)
                    }
            {% if extra_select %}
                {% for instance in extra_select %}
                else if (step === extra_step_{{ forloop.counter }}) {
                    var select_element = document.createElement('select');
                        select_element.style = 'align-self: center; width: 150px; height: 20px'

                        select_element.className = el + 'textfield' + ' extra_property_select_{{ forloop.counter }}'

                        {% dict_get extra_query instance as dict_get_query %}
                        {% for i in dict_get_query %}

                        var option = document.createElement("option");
                        option.value = '{{i.id}}';
                        option.text = '{{i.name}}';
                        extra_discard_{{ forloop.parentloop.counter }} = e.textContent
                        if (option.text === e.textContent){
                            option.selected = true}
                        select_element.appendChild(option);

                        {% endfor %}
                        e.parentNode.replaceChild(select_element, e);
                        var extra_svg_image_{{ forloop.counter }} = svg_image.cloneNode(true)

                        extra_svg_image_{{ forloop.counter }}.id = el + 'extra_add_svg_{{ forloop.counter }}'
                        extra_svg_image_{{ forloop.counter }}.setAttribute('onclick', `ExtraCreate_{{ forloop.counter }}()`)
                        select_element.after(extra_svg_image_{{ forloop.counter }})
                }
            {% if pdf_file %}
                else if (step === pdf_step){
                    var d = document.createElement('input');
                    var currently = document.createElement('a')
                    var p_obj = document.createElement('p')


                    currently.href = e.href
                    d.type = 'file'
                    d.innerHTML = e.innerHTML
                    d.placeholder = e.textContent;
                    d.className = el + 'textfield'
                    p_obj.innerHTML = `Currently: <a target="_blank" href="${e.href}">${e.href.split('http://127.0.0.1:8000/media/uploads/')[1]}</a>
                                       <span class="clearable-file-input">
                                       <input type="checkbox" name="pdf_file-clear" id="pdf_file_clear_${el}">
                                       <label for="pdf_file-clear_id">Clear</label></span><br>
                                       Change:
                                       <input type="file" style="font-size: x-small" name="pdf_file" id="id_pdf_file" class='${el + 'textfield'}'></p>`
                    p_obj.style.fontSize = 'x-small'
                    e.parentNode.replaceChild(p_obj, e);
                }
            {% endif %}
                {% endfor %}
            {% endif %}

                else {
                    var d = document.createElement('input');
                    d.type = 'text'
                    d.innerHTML = e.innerHTML
                    d.value = e.textContent;
                    d.placeholder = e.textContent;
                    d.className = el + 'textfield'
                    e.parentNode.replaceChild(d, e);
                }

                }
            }

    {% if extra_select %}
    {% for instance in extra_select %}
            function ExtraCreate_{{ forloop.counter }}(){
                // Get the modal
                var modal = document.getElementById("extra_myModal_{{ forloop.counter }}");

                // Get the <span> element that closes the modal
                var span = document.getElementById("extra_close_property_{{ forloop.counter }}");

                // When the user clicks the button, open the modal
                  modal.style.display = "block";


                // When the user clicks on <span> (x), close the modal
                span.onclick = function() {
                  modal.style.display = "none";
                }

                // When the user clicks anywhere outside of the modal, close it
                window.onclick = function(event) {
                  if (event.target == modal) {
                    modal.style.display = "none";
                  }
                }
            }

            function Extra_Add_{{ forloop.counter }}(){
                {% dict_get extra_query_keys instance as dict_get_query %}
                {% for field in dict_get_query %}
                    let {{ field }} = document.getElementById('extra_{{ forloop.parentloop.counter }}_{{ field }}')
                {% endfor %}
                {# TODO поля могут быть не текст филд а селектион #}
                {#let name = document.getElementById('property_name')#}
                {#let u_m = document.getElementById('u_m')#}
                {#let description = document.getElementById('description')#}

                var dict = {
                    {% for field in dict_get_query %}
                        {% if field != 'id' %}
                    '{{ field }}': {{ field }}.value,
                        {% endif %}
                    {#'u_m': u_m.value,#}
                    {#'description': description.value#}
                    {% endfor %}
                }


                var xhr = new XMLHttpRequest();
                {% dict_get extra_url instance as extra_url_instance %}
                xhr.open("POST", '../{{ extra_url_instance }}/', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.responseType = 'json';
                xhr.onload  = function() {
                    var jsonResponse = xhr.response;
                    var extra_property_select_{{ forloop.counter }} = document.getElementsByClassName('extra_property_select_{{ forloop.counter }}')[0]
                    var option = document.createElement("option");
                    option.value = jsonResponse['id']
                    option.text = name.value
                    option.selected = true
                    extra_property_select_{{ forloop.counter }}.appendChild(option)
                }
                var modal = document.getElementById("extra_myModal_{{ forloop.counter }}");
                modal.style.display = "none"
                xhr.send(JSON.stringify(dict));




                console.log(123)

    }
    {% endfor %}
    {% endif %}

            function CreateProperty(){
                // Get the modal
                var modal = document.getElementById("myModal");

                // Get the <span> element that closes the modal
                var span = document.getElementById("close_property");

                // When the user clicks the button, open the modal
                  modal.style.display = "block";


                // When the user clicks on <span> (x), close the modal
                span.onclick = function() {
                  modal.style.display = "none";
                }

                // When the user clicks anywhere outside of the modal, close it
                window.onclick = function(event) {
                  if (event.target == modal) {
                    modal.style.display = "none";
                  }
                }
            }

            function PropertyAdd(){
                {% for field in upper_query.0.keys %}
                    let {{ field }} = document.getElementById('upper_{{ field }}')
                {% endfor %}
                {# TODO поля могут быть не текст филд а селектион #}
                {#let name = document.getElementById('property_name')#}
                {#let u_m = document.getElementById('u_m')#}
                {#let description = document.getElementById('description')#}

                var dict = {
                    {% for field in upper_query.0.keys %}
                        {% if field != 'id' %}
                    '{{ field }}': {{ field }}.value,
                        {% endif %}
                    {#'u_m': u_m.value,#}
                    {#'description': description.value#}
                    {% endfor %}
                }


                var xhr = new XMLHttpRequest();
                xhr.open("POST", '../{{ btn_fields.upper_url }}/', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.responseType = 'json';
                xhr.onload  = function() {
                    var jsonResponse = xhr.response;
                    var property_select = document.getElementsByClassName('property_select')[0]
                    var option = document.createElement("option");
                    option.value = jsonResponse['id']
                    option.text = name.value
                    option.selected = true
                    if ([200, 201].includes(xhr.status)) {
                        property_select.appendChild(option)
                    }
                    else {
                        var alert_div = document.getElementById("alert_button")
                        var alert_span = document.getElementById("alert_span")
                        alert_div.style.display = "block"
                        alert_div.style.backgroundColor = "#f44336"
                        alert_div.textContent = "Не удалось создать {{ btn_fields.upper_name }}"
                        alert_div.appendChild(alert_span)

                    }

                }
                var modal = document.getElementById("myModal");
                modal.style.display = "none"
                xhr.send(JSON.stringify(dict));

    }

            function ChangeButtonReturn(el){
                var d = el + 'can_con'
                // window.alert(d)
                const can_con = Array.from(document.getElementsByClassName(d));
                can_con.forEach(box => {
                    box.remove();
            });
                var from = document.getElementById(el + 'changebutton')
                from.style.display = 'table-cell'
                // can_con[0].remove()
                // can_con[1].remove()
            }

            function DiscardChanges(el){

                for (let step = 0; step < steps; step++){
                    var d = document.getElementsByClassName(el+'textfield')[0];
                    var e = document.createElement('a');
                    e.className = "btn " + el
                    e.setAttribute('onclick', 'handleClick(this)')
                    e.style.color = 'black'
                    e.textContent = d.placeholder
                    if (step === selection_step){
                        e.textContent = upper_discard
                    }
                    {% if extra_select %}
                    {% for instance in extra_select %}
                    if (step === extra_step_{{ forloop.counter }}) {
                        e.textContent = extra_discard_{{ forloop.counter }}
                    }
                    {% endfor %}
                    {% endif %}
                    // TODO доделать href
                    d.parentNode.replaceChild(e, d);
                }
                {% if upper_query != None %}
                    var add_svg = document.getElementById(el + 'add_svg')
                    {#var add_svg_1 = document.getElementById(el + 'add_svg_1')#}

                    add_svg.remove()
                {% endif %}
                {% if extra_select != None %}
                    {% for inst in extra_select %}
                        var extra_add_svg_{{ forloop.counter }} = document.getElementById(el + 'extra_add_svg_{{ forloop.counter }}')
                        extra_add_svg_{{ forloop.counter }}.remove()
                    {% endfor %}
                {% endif %}
                    {#add_svg_1.remove()#}
                    ChangeButtonReturn(el);
                }


            function SubmitChanges(el){
                const dict = {}
                    var is_required_tocreate = true
                    var element = document.getElementsByClassName(el+'textfield');

                    for (const elem of submit){
                        if (elem['id'] === el){
                            {% for l in query.0.keys|dict_id_pop %}
                                {% if l != 'pdf_file' %}
                                    elem['{{l}}'] = element[{{ forloop.counter0 }}].value
                                {% else %}
                                    elem['{{l}}'] = element[{{ forloop.counter0 }}].files[0]
                                {% endif %}
                            {% endfor %}
                            is_required_tocreate = false
                        }
                    }

                    if (is_required_tocreate === true) {
                        dict['id'] = el
                        {% for i in query.0.keys|dict_id_pop %}
                            {% if i != 'pdf_file' %}
                                dict['{{i}}'] = element[{{ forloop.counter0 }}].value
                            {% else %}
                                dict['{{i}}'] = element[{{ forloop.counter0 }}].files[0]
                            {% endif %}
                        {% endfor %}
                        submit.push(dict)
                    }

                for (let step = 0; step < steps; step++){
                    var d = document.getElementsByClassName(el+'textfield')[0];
                    var e = document.createElement('a');
                    e.className = "btn " + el
                    e.setAttribute('onclick', 'handleClick(this)')
                    e.style.color = 'black'
                    e.textContent = d.value
                    if (step === selection_step ) {
                        e.textContent = d.options[d.selectedIndex].text
                    }
                    {% if extra_select %}
                    {% for instance in extra_select %}
                    if (step === extra_step_{{ forloop.counter }}) {
                        e.textContent = d.options[d.selectedIndex].text
                    }
                    {% endfor %}
                    {% endif %}

                    {#if (step === 0) {#}
                    {#    e.textContent = d.options[d.selectedIndex].text#}

                    // TODO доделать href
                    d.parentNode.replaceChild(e, d);
                }
                {% if upper_query != None %}
                    var add_svg = document.getElementById(el + 'add_svg')
                    {#var add_svg_1 = document.getElementById(el + 'add_svg_1')#}

                    add_svg.remove()
                {% endif %}
                {% if extra_select != None %}
                    {% for inst in extra_select %}
                        var extra_add_svg_{{ forloop.counter }} = document.getElementById(el + 'extra_add_svg_{{ forloop.counter }}')
                        extra_add_svg_{{ forloop.counter }}.remove()
                    {% endfor %}
                {% endif %}
                    {#add_svg_1.remove()#}
                    ChangeButtonReturn(el);
                }

            function PageReload() {
                // if (flag)
                {#window.location.href = '.'#}
                location.reload()
                return false
    }

                    // document.write(submit.get('name'), submit.get('address'), submit.get('holding'));

            function CreateObj() {
                {% for field in query.0.keys %}
                    let {{ field }} = document.getElementById('current_{{ field }}')
                {% endfor %}
                {# TODO поля могут быть не текст филд а селектион #}
                {# TODO ЕСЛИ ВРЕМЯ ТО input type='time' or smth like that #}
                {% if pdf_file %}
                    let formData = new FormData();
                    {% for field in query.0.keys %}
                        {% if field != 'id' and field != 'pdf_file'%}
                            formData.append('{{field}}', {{field}}.value)
                        {% elif field == 'pdf_file' %}
                            formData.append('{{field}}', {{field}}.files[0])
                        {% endif %}
                    {% endfor %}
                            let file_response = new XMLHttpRequest();
                    file_response.open("POST", './');
                    file_response.onload = post_error_handler(file_response)
                    file_response.send(formData)
                    console.log(file_response.status)
                {% else %}
                var dict = {
                    {% for field in query.0.keys %}
                        {% if field != 'id' and field != 'pdf_file'%}
                            '{{ field }}': {{ field }}.value,
                        {% elif field == 'pdf_file' %}
                            '{{ field }}': {{ field }}, {# TODO нужно ли про pdf_file что либо? #}
                        {% endif %}
                    {% endfor %}
                }
                console.log(dict)
                {% if retrieve %}
                let create_response = fetch('../', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json;charset=utf-8'
                },
                body: JSON.stringify(dict)
                }).then(response => post_error_handler(response))
                {% else %}
                let create_response = fetch('', {
                method: 'POST',
                headers: {
                'Content-Type': 'multipart/form-data'
                },
                body: JSON.stringify(dict)
                }).then(response => post_error_handler(response))
                {% endif %}
                {% endif %}
            }


             function post_error_handler(response) {

              if ([200, 201].includes(response.status)) {
                    sessionStorage.setItem("success", "true");
                    PageReload()
              }
              else if (response.status === 400) {
                    sessionStorage.setItem("error", "true");

                    sessionStorage.setItem("error_response", response.json().toString()) {# TODO доделать если есть необходимость#}
                    PageReload()
                            }
              else {
                  sessionStorage.setItem("show_response", "true")
                  sessionStorage.setItem("response", response.statusText)
                  PageReload()
      }
              if (sessionStorage.getItem("error") === "true") {
                sessionStorage.setItem("success", "false");
            }
            }


             function SaveChanges(){
                // window.alert(submit)
                {#console.log(submit)#}
                {% if pdf_file %}

                 let update_no_file_response = fetch('./update/', {
                    method: 'PUT',
                    headers: {
                    'Content-Type': 'application/json;charset=utf-8'
                    },
                    body: JSON.stringify(submit) {# todo удалить pdf_file inst отсюдова #}
                    }).then((response) => {
                    console.log(response.status)
                    if (response.status === 200) {
                    let file_update_response = new XMLHttpRequest();
                    let file_formData = new FormData();
                    var sub_dict = []

                    for (const elem of submit){
                        var id = elem['id']
                        if (document.getElementById('pdf_file_clear_' + id).checked !== true){
                            var file = elem['pdf_file']
                            }
                        else {
                            file = None
                        }
                        {#sub_dict.push({id : file})#}
                        file_formData.append(id, file)
                    }

                    file_update_response.open("POST", './file_update/');
                    file_update_response.onload = function () {
                        if (file_update_response.status === 200 && response.status === 200)
                            post_error_handler(200)
                        else
                            post_error_handler(400)
                    }
                    file_update_response.send(file_formData)}
                    })
                {% else %}



                let update_response = fetch('./update/', {
                method: 'PUT',
                headers: {
                'Content-Type': 'application/json;charset=utf-8'
                },
                body: JSON.stringify(submit)
                }).then(response => post_error_handler(response))

                console.log(update_response.status)

                const elements = document.querySelectorAll('input[type=checkbox]:checked')

                var xhr1_list = []

                elements.forEach(element =>{
                    if (element.class === 'dip') {
                        xhr1_list.push(element.id})
                })

                let delete_reponse = fetch('./delete/', {
                method: 'DELETE',
                headers: {
                'Content-Type': 'application/json;charset=utf-8'},
                body: JSON.stringify({'id': xhr1_list})
                }).then(response => post_error_handler(response))


                //    TODO Здесь тоже хандлить ошибки
                 {% endif %}
                }


            {#const form = document.getElementById('current_form')#}
            {#form.addEventListener("submit", CreateObj())#}

            function None(button){
                button.onclick.disabled = true
            }

            function insertAfter(referenceNode, newNode) {
  referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
}



        </script>
    <div id="createform" >
    <form action = "javascript:void(0)" id = 'current_form' style="background-color: white; box-shadow: rgba(255, 255, 255, 0.2) 0px 0px 0px 1px inset, rgba(0, 0, 0, 0.9) 0px 0px 0px 1px;" >
    {% for i in query.0.keys|dict_id_pop %}
  <div>
    {% if i == btn_fields.upper_name %}
        {{ model | verbose_name:i }}<br>
        <input list="listsds" id="current_{{ i }}" name="current_{{ i }}">
        <datalist id="listsds" name="current_{{ i }}" style="width: 177px">
        {% for instance in upper_query %}
            {% if instance.FIO != None%} {# TODO сделать нормально через tags #}
            <option value="{{instance.id}}">{{instance.FIO}}</option>
            {% elif instance.invent_num != None%}
            <option value="{{instance.id}}">{{instance.invent_num}}</option>
            {% else %}
            <option value="{{instance.id}}">{{instance.name}}</option>
            {% endif %}
        {% endfor %}
        </datalist>
        </div>
    {% elif i in extra_select %}
        {{ model | verbose_name:i }}<br>
        <select id="current_{{ i }}" name="current_{{ i }}" style="width: 177px">
        {% dict_get extra_query i as dict_get_query %}
        {% for query in dict_get_query %}
            <option value="{{query.id}}">{{query.name}}</option>
        {% endfor %}
        </select>
        </div>
    {% elif i == 'pdf_file' %}
    <label for="current_{{ i }}">{{ model | verbose_name:i }}</label><br>
    <input type='file' name="current_{{ i }}" id="current_{{ i }}"/>
    {% else %}
    <label for="current_{{ i }}">{{ model | verbose_name:i }}</label><br>
    <input name="current_{{ i }}" id="current_{{ i }}"/>
    </div>
    {% endif %}
    {% endfor %}

  <div>
      <br>
    <button onclick = "CreateObj()" style="padding: 3%" type = 'submit' class="button-6">Добавить организацию</button>
      </div>
      <div>
      <div id='container'>
      {% if success_create %}
      <br><div id="backgroundsuccess">Организация успешно создана</div>
      {% endif %}
      </div>
      </div>
</form>
        </div>
        <script>
            {#const form = document.getElementById('current_form');#}
            {#form.addEventListener("submit", CreateObj)#}
        </script>
</head>


</body>
</html>